<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Upload with Mask</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/4.5.0/fabric.min.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f9f9f9;
            color: #333;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 20px;
        }

        .controls button,
        .controls input {
            margin: 5px;
            padding: 10px 15px;
            font-size: 14px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .controls button {
            background-color: #007bff;
            color: #fff;
        }

        .controls button:hover {
            background-color: #0056b3;
        }

        .controls input[type="file"] {
            padding: 5px;
        }

        .controls input[type="color"] {
            padding: 5px;
            border: 1px solid #ccc;
        }

        .thumbnail-container {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        .thumbnail {
            width: 50px;
            height: 50px;
            margin: 0 5px;
            cursor: pointer;
            border: 2px solid #ccc;
            border-radius: 5px;
        }

        .thumbnail:hover {
            border-color: #007bff;
        }

        .canvas-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-bottom: 20px;
        }

        canvas {
            border: 2px solid #007bff;
            border-radius: 10px;
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: center;
            }

            .controls button,
            .controls input {
                width: 100%;
                max-width: 300px;
            }

            .thumbnail {
                width: 40px;
                height: 40px;
            }
        }
    </style>
</head>

<body>
    <div class="thumbnail-container" id="thumbnailContainer">
        <!-- Thumbnails will be dynamically added here -->
    </div>
    <input type="file" id="fileUpload" />
    <div class="canvas-container">
        <canvas id="canvas"></canvas>
    </div>
    <div class="controls">
        <button id="drawModeBtn">Enable Draw Mode</button>
        <button id="eraseModeBtn">Enable Erase Mode</button>
        <button id="fillModeBtn">Enable Fill Mode</button>
        <button id="resizeModeBtn">Disable Resize Mode</button>
        <button id="undoBtn">Undo</button>
        <button id="downloadBtn">Download Image</button>
        <input type="color" id="colorPicker" value="#000000">
    </div>

    <script>
        const canvas = new fabric.Canvas('canvas', {
            width: 600,
            height: 600,
        });
        const fileUpload = document.getElementById('fileUpload');
        const downloadBtn = document.getElementById('downloadBtn');
        const drawModeBtn = document.getElementById('drawModeBtn');
        const eraseModeBtn = document.getElementById('eraseModeBtn');
        const fillModeBtn = document.getElementById('fillModeBtn');
        const resizeModeBtn = document.getElementById('resizeModeBtn');
        const undoBtn = document.getElementById('undoBtn');
        const colorPicker = document.getElementById('colorPicker');
        const thumbnailContainer = document.getElementById('thumbnailContainer');
        const maskUrls = [
            'https://raw.githubusercontent.com/snoop-frog/te/main/octoframe2.png',
            'https://raw.githubusercontent.com/snoop-frog/te/main/octoframe2.png',
            'https://raw.githubusercontent.com/snoop-frog/te/main/octoframe2.png',
            'https://raw.githubusercontent.com/snoop-frog/te/main/octoframe2.png',
            'https://raw.githubusercontent.com/snoop-frog/te/main/octoframe2.png'
        ];
        const logoUrl = 'https://raw.githubusercontent.com/snoop-frog/te/main/PNG.png';
        let uploadedImg;
        let logoImg;
        let isDrawingMode = false;
        let isErasingMode = false;
        let isFillMode = false;
        let isResizeMode = true;
        let isDragging = false;
        const gridSize = 38;
        const cellSize = 600 / gridSize;
        const history = [];

        const offscreenCanvas = document.createElement('canvas');
        offscreenCanvas.width = 600;
        offscreenCanvas.height = 600;
        const offscreenCtx = offscreenCanvas.getContext('2d');

        function createMaskThumbnails() {
            maskUrls.forEach((url, index) => {
                const img = new Image();
                img.src = url;
                img.classList.add('thumbnail');
                img.onclick = () => applyMask(url);
                thumbnailContainer.appendChild(img);
            });

            // Apply the first mask by default
            applyMask(maskUrls[0]);
        }

        function upscaleImage(src, scaleFactor, callback) {
            const img = new Image();
            img.crossOrigin = "Anonymous";
            img.onload = function () {
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = img.width * scaleFactor;
                tempCanvas.height = img.height * scaleFactor;
                const tempCtx = tempCanvas.getContext('2d');
                tempCtx.imageSmoothingEnabled = false;
                tempCtx.drawImage(img, 0, 0, tempCanvas.width, tempCanvas.height);
                callback(tempCanvas.toDataURL());
            };
            img.src = src;
        }

        function applyMask(maskUrl) {
            upscaleImage(maskUrl, 21, function (upscaledMaskUrl) {
                const img = new Image();
                img.crossOrigin = "Anonymous";
                img.onload = function () {
                    offscreenCtx.clearRect(0, 0, offscreenCanvas.width, offscreenCanvas.height);
                    offscreenCtx.drawImage(img, 0, 0, offscreenCanvas.width, offscreenCanvas.height);
                    updateMainCanvas();
                };
                img.src = upscaledMaskUrl;
            });
        }

        function addLogoToCanvas() {
            fabric.Image.fromURL(logoUrl, function (img) {
                const scaleFactor = 500 / img.width;
                img.set({
                    left: (600 - 500) / 2,
                    top: 600 * 0.125,
                    scaleX: scaleFactor,
                    scaleY: scaleFactor,
                    selectable: false,
                    evented: false,
                });
                logoImg = img;
                canvas.add(img);
                img.bringToFront();
            }, { crossOrigin: 'anonymous' });
        }

        createMaskThumbnails();
        addLogoToCanvas(); // Add the logo when the page loads

        fileUpload.addEventListener('change', function (e) {
            const reader = new FileReader();
            reader.onload = function (event) {
                fabric.Image.fromURL(event.target.result, function (img) {
                    const scaleFactor = Math.max(270 / img.width, 270 / img.height);
                    img.set({
                        left: 165, // Adjust for smaller canvas
                        top: 165, // Adjust for smaller canvas
                        scaleX: scaleFactor,
                        scaleY: scaleFactor,
                        selectable: true,
                        evented: true,
                        clipPath: new fabric.Rect({
                            left: 165, // Adjust for smaller canvas
                            top: 165, // Adjust for smaller canvas
                            width: 270,
                            height: 270,
                            absolutePositioned: true
                        })
                    });
                    if (uploadedImg) {
                        canvas.remove(uploadedImg);
                    }
                    uploadedImg = img;
                    canvas.add(img);
                    canvas.setActiveObject(img);
                    enterResizeMode(); // Automatically enter resize mode
                    if (logoImg) {
                        logoImg.bringToFront(); // Ensure the logo is on top
                    }
                }, { crossOrigin: 'anonymous' });
            };
            reader.readAsDataURL(e.target.files[0]);
        });

        drawModeBtn.addEventListener('click', function () {
            isDrawingMode = !isDrawingMode;
            isErasingMode = false;
            isFillMode = false;
            isResizeMode = false;
            canvas.selection = !isDrawingMode;
            if (uploadedImg) {
                uploadedImg.selectable = !isDrawingMode;
                uploadedImg.evented = !isDrawingMode;
            }
            drawModeBtn.textContent = isDrawingMode ? 'Disable Draw Mode' : 'Enable Draw Mode';
            eraseModeBtn.textContent = 'Enable Erase Mode';
            fillModeBtn.textContent = 'Enable Fill Mode';
            resizeModeBtn.textContent = 'Enable Resize Mode';
            if (logoImg) {
                logoImg.bringToFront(); // Ensure the logo is on top
            }
        });

        eraseModeBtn.addEventListener('click', function () {
            isErasingMode = !isErasingMode;
            isDrawingMode = false;
            isFillMode = false;
            isResizeMode = false;
            canvas.selection = !isErasingMode;
            if (uploadedImg) {
                uploadedImg.selectable = !isErasingMode;
                uploadedImg.evented = !isErasingMode;
            }
            eraseModeBtn.textContent = isErasingMode ? 'Disable Erase Mode' : 'Enable Erase Mode';
            drawModeBtn.textContent = 'Enable Draw Mode';
            fillModeBtn.textContent = 'Enable Fill Mode';
            resizeModeBtn.textContent = 'Enable Resize Mode';
            if (logoImg) {
                logoImg.bringToFront(); // Ensure the logo is on top
            }
        });

        fillModeBtn.addEventListener('click', function () {
            isFillMode = !isFillMode;
            isDrawingMode = false;
            isErasingMode = false;
            isResizeMode = false;
            canvas.selection = !isFillMode;
            if (uploadedImg) {
                uploadedImg.selectable = !isFillMode;
                uploadedImg.evented = !isFillMode;
            }
            fillModeBtn.textContent = isFillMode ? 'Disable Fill Mode' : 'Enable Fill Mode';
            drawModeBtn.textContent = 'Enable Draw Mode';
            eraseModeBtn.textContent = 'Enable Erase Mode';
            resizeModeBtn.textContent = 'Enable Resize Mode';
            if (logoImg) {
                logoImg.bringToFront(); // Ensure the logo is on top
            }
        });

        resizeModeBtn.addEventListener('click', function () {
            isResizeMode = !isResizeMode;
            isDrawingMode = false;
            isErasingMode = false;
            isFillMode = false;
            enterResizeMode();
            if (logoImg) {
                logoImg.bringToFront(); // Ensure the logo is on top
            }
        });

        function enterResizeMode() {
            canvas.selection = isResizeMode;
            if (uploadedImg) {
                uploadedImg.selectable = isResizeMode;
                uploadedImg.evented = isResizeMode;
                canvas.setActiveObject(uploadedImg);
            }
            resizeModeBtn.textContent = isResizeMode ? 'Disable Resize Mode' : 'Enable Resize Mode';
            drawModeBtn.textContent = 'Enable Draw Mode';
            eraseModeBtn.textContent = 'Enable Erase Mode';
            fillModeBtn.textContent = 'Enable Fill Mode';
            if (logoImg) {
                logoImg.bringToFront(); // Ensure the logo is on top
            }
        }

        function saveState() {
            const imageData = offscreenCtx.getImageData(0, 0, offscreenCanvas.width, offscreenCanvas.height);
            history.push(imageData);
        }

        canvas.on('mouse:down', function (options) {
            if (options.pointer) {
                if (isDrawingMode || isErasingMode) {
                    isDragging = true;
                    saveState();
                    drawOrEraseGridSquare(options.pointer);
                } else if (isFillMode) {
                    saveState();
                    fillArea(options.pointer);
                }
            }
        });

        canvas.on('mouse:move', function (options) {
            if ((isDrawingMode || isErasingMode) && isDragging && options.pointer) {
                drawOrEraseGridSquare(options.pointer);
            }
        });

        canvas.on('mouse:up', function () {
            isDragging = false;
            updateMainCanvas();
        });

        function drawOrEraseGridSquare(pointer) {
            const zoom = canvas.getZoom();
            const x = Math.floor(pointer.x / cellSize / zoom) * cellSize;
            const y = Math.floor(pointer.y / cellSize / zoom) * cellSize;

            if (isDrawingMode) {
                offscreenCtx.fillStyle = colorPicker.value;
                offscreenCtx.fillRect(x, y, cellSize, cellSize);
            } else if (isErasingMode) {
                offscreenCtx.clearRect(x, y, cellSize, cellSize);
            }

            updateMainCanvas();
        }

        function fillArea(pointer) {
            const zoom = canvas.getZoom();
            const x = Math.floor(pointer.x / cellSize / zoom) * cellSize;
            const y = Math.floor(pointer.y / cellSize / zoom) * cellSize;

            const targetColor = getPixelColor(x, y);
            const fillColor = hexToRgba(colorPicker.value);

            if (targetColor[3] === 0 || colorsMatch(targetColor, fillColor)) return;

            floodFill(x, y, targetColor, fillColor);
            updateMainCanvas();
        }

        function getPixelColor(x, y) {
            const pixel = offscreenCtx.getImageData(x, y, 1, 1).data;
            return [pixel[0], pixel[1], pixel[2], pixel[3]];
        }

        function hexToRgba(hex) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return [r, g, b, 255];
        }

        function colorsMatch(color1, color2) {
            return color1[0] === color2[0] &&
                color1[1] === color2[1] &&
                color1[2] === color2[2] &&
                color1[3] === color2[3];
        }

        function floodFill(x, y, targetColor, fillColor) {
            const stack = [[x, y]];

            while (stack.length > 0) {
                const [currentX, currentY] = stack.pop();
                const currentColor = getPixelColor(currentX, currentY);

                if (colorsMatch(currentColor, targetColor)) {
                    offscreenCtx.fillStyle = `rgba(${fillColor[0]}, ${fillColor[1]}, ${fillColor[2]}, ${fillColor[3] / 255})`;
                    offscreenCtx.fillRect(currentX, currentY, cellSize, cellSize);

                    stack.push([currentX + cellSize, currentY]);
                    stack.push([currentX - cellSize, currentY]);
                    stack.push([currentX, currentY + cellSize]);
                    stack.push([currentX, currentY - cellSize]);
                }
            }
        }

        function updateMainCanvas() {
            const dataUrl = offscreenCanvas.toDataURL();
            fabric.Image.fromURL(dataUrl, function (img) {
                img.set({
                    left: 0,
                    top: 0,
                    selectable: false,
                    evented: false
                });
                canvas.clear();
                if (uploadedImg) {
                    canvas.add(uploadedImg);
                }
                if (logoImg) {
                    canvas.add(logoImg);
                    logoImg.bringToFront();
                }
                canvas.add(img);
                if (isResizeMode && uploadedImg) {
                    canvas.setActiveObject(uploadedImg); // Keep the image active for resizing
                }
            });
        }

        undoBtn.addEventListener('click', function () {
            if (history.length > 0) {
                const lastState = history.pop();
                offscreenCtx.putImageData(lastState, 0, 0);
                updateMainCanvas();
            }
        });

        colorPicker.addEventListener('change', function () {
            if (canvas.freeDrawingBrush) {
                canvas.freeDrawingBrush.color = colorPicker.value;
            }
        });

        downloadBtn.addEventListener('click', function () {
            canvas.discardActiveObject();
            canvas.requestRenderAll();

            const dataURL = canvas.toDataURL({
                format: 'png',
                quality: 1.0
            });

            const link = document.createElement('a');
            link.download = 'octomask-composite.png';
            link.href = dataURL;
            link.click();
        });

        canvas.on('object:added', function () {
            if (logoImg) {
                logoImg.bringToFront(); // Ensure the logo is on top
            }
        });

        canvas.on('object:modified', function () {
            if (logoImg) {
                logoImg.bringToFront(); // Ensure the logo is on top
            }
        });

        canvas.on('mouse:down', function () {
            if (logoImg) {
                logoImg.bringToFront(); // Ensure the logo is on top
            }
        });

        canvas.on('after:render', function () {
            if (logoImg) {
                logoImg.bringToFront(); // Ensure the logo is on top
            }
        });

        // Add touch event support for mobile
        canvas.on('touch:gesture', function (options) {
            const event = options.e;
            if (event.touches && event.touches.length === 2) {
                canvas.isDrawingMode = false;
                const point = new fabric.Point(canvas.width / 2, canvas.height / 2);
                if (options.self.scaleX !== 1 && options.self.scaleY !== 1) {
                    canvas.zoomToPoint(point, options.self.scaleX);
                }
            }
        });

        canvas.on('touch:drag', function (options) {
            const event = options.e;
            if (event.touches && event.touches.length === 1) {
                const delta = new fabric.Point(options.self.x, options.self.y);
                canvas.relativePan(delta);
            }
        });

        canvas.on('touch:longpress', function (options) {
            const event = options.e;
            if (event.touches && event.touches.length === 1) {
                const touch = event.touches[0];
                const pointer = canvas.getPointer(touch);
                const object = canvas.findTarget(pointer, true);
                if (object) {
                    canvas.setActiveObject(object);
                }
            }
        });

        // Adjust canvas size on window resize
        window.addEventListener('resize', resizeCanvas);

        function resizeCanvas() {
            const container = document.querySelector('.canvas-container');
            const containerWidth = container.clientWidth;

            canvas.setWidth(containerWidth);
            canvas.setHeight(containerWidth);

            canvas.setZoom(containerWidth / 600);
            canvas.renderAll();
        }

        resizeCanvas();
    </script>
</body>

</html>
